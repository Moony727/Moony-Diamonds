name: Deploy Moony Diamonds to GitHub Pages

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pages: write
      id-token: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm install

    - name: Inject secrets into script
      run: |
        echo "ðŸ”§ Injecting secrets into script.js..."
        sed -i "s|AIzaSyARlXv5U3jZI6qBRxGrLTgc4rk7_PHfjvY|${FIREBASE_API_KEY}|g" src/script.js
        sed -i "s|moony-diamonds-9dad2.firebaseapp.com|${FIREBASE_AUTH_DOMAIN}|g" src/script.js
        sed -i "s|https://moony-diamonds-9dad2-default-rtdb.firebaseio.com|${FIREBASE_DATABASE_URL}|g" src/script.js
        sed -i "s|moony-diamonds-9dad2|${FIREBASE_PROJECT_ID}|g" src/script.js
        sed -i "s|moony-diamonds-9dad2.firebasestorage.app|${FIREBASE_STORAGE_BUCKET}|g" src/script.js
        sed -i "s|790247761631|${FIREBASE_MESSAGING_SENDER_ID}|g" src/script.js
        sed -i "s|1:790247761631:web:808cb99a00bf32a0302b6a|${FIREBASE_APP_ID}|g" src/script.js
        sed -i "s|8394488712:AAGnpElivxAzZgpX7wFb-kiIleBAjcACjGQ|${TELEGRAM_BOT_TOKEN}|g" src/script.js
        sed -i "s|-1003066832876|${TELEGRAM_CHANNEL_ID}|g" src/script.js
      env:
        FIREBASE_API_KEY: ${{ secrets.FIREBASE_API_KEY }}
        FIREBASE_AUTH_DOMAIN: ${{ secrets.FIREBASE_AUTH_DOMAIN }}
        FIREBASE_DATABASE_URL: ${{ secrets.FIREBASE_DATABASE_URL }}
        FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
        FIREBASE_STORAGE_BUCKET: ${{ secrets.FIREBASE_STORAGE_BUCKET }}
        FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}
        FIREBASE_APP_ID: ${{ secrets.FIREBASE_APP_ID }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHANNEL_ID: ${{ secrets.TELEGRAM_CHANNEL_ID }}

    - name: Build Moony Diamonds
      run: npm run build

    - name: Setup Pages
      uses: actions/configure-pages@v4

    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: './dist'

    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
